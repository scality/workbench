[SERVICE]
    Flush        10
    Grace        10
    Parsers_File /fluent-bit/etc/parsers.conf

    Log_Level    {{ .Fluentbit.LogLevel }}
    Log_File     /var/log/fluent-bit/fluent-bit.log

    # HTTP server for prometheus metrics
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_PORT    2020

[INPUT]
    Name             tail
    Path             /fluent-bit/log/server-access.log
    Tag              access_logging
    Read_from_Head   true

    # Sync with cloudserver checkFileRotationIntervalMS (10000ms)
    # rotate_wait should be >= checkFileRotationIntervalMS to avoid losing logs
    rotate_wait      30
    refresh_interval 5

    # Database for tracking file offsets across restarts
    DB                /fluent-bit/data/tail.db
    DB.locking        true
    DB.sync           normal
    DB.journal_mode   wal

[FILTER]
    Name     parser
    Key_Name log
    Match    access_logging
    Parser   json_parser

[FILTER]
    Name          record_modifier
    Match         access_logging

    # Common
    Allowlist_key hostname

    # Analytics
    Allowlist_key action
    Allowlist_key accountName
    Allowlist_key accountDisplayName
    Allowlist_key httpMethod
    Allowlist_key userName
    Allowlist_key bytesDeleted
    Allowlist_key bytesReceived
    Allowlist_key bodyLength
    Allowlist_key contentLength
    Allowlist_key elapsed_ms

    # AWS
    Allowlist_key startTime
    Allowlist_key requester
    Allowlist_key operation
    Allowlist_key requestURI
    Allowlist_key errorCode
    Allowlist_key objectSize
    Allowlist_key totalTime
    Allowlist_key turnAroundTime
    Allowlist_key referer
    Allowlist_key userAgent
    Allowlist_key versionId
    Allowlist_key signatureVersion
    Allowlist_key cipherSuite
    Allowlist_key authenticationType
    Allowlist_key hostHeader
    Allowlist_key tlsVersion
    Allowlist_key aclRequired

    # Shared AWS and Analytics
    Allowlist_key bucketOwner
    Allowlist_key bucketName
    Allowlist_key req_id
    Allowlist_key bytesSent
    Allowlist_key clientIP
    Allowlist_key httpCode
    Allowlist_key objectKey

    # Scality server access logs extra fields
    Allowlist_key logFormatVersion
    Allowlist_key loggingEnabled
    Allowlist_key loggingTargetBucket
    Allowlist_key loggingTargetPrefix
    Allowlist_key awsAccessKeyID
    Allowlist_key raftSessionID

[OUTPUT]
    Name             http
    Match            access_logging
    Host             127.0.0.1
    Port             8123
    URI              /?query=INSERT+INTO+logs.access_logs_ingest+FORMAT+JSONEachRow
    format           json_stream
    json_date_key    timestamp
    json_date_format epoch
    Retry_Limit      5
